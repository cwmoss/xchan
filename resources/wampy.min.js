/**
 * Minified by jsDelivr using Terser v5.15.1.
 * Original file: /npm/wampy@7.0.2/dist/wampy.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=exports.Wampy=exports.Errors=void 0;var _constants=require("./constants.js"),Errors=_interopRequireWildcard(require("./errors.js"));exports.Errors=Errors;var _utils=require("./utils.js"),_JsonSerializer=require("./serializers/JsonSerializer.js");function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var r=new WeakMap,t=new WeakMap;return(_getRequireWildcardCache=function(e){return e?t:r})(e)}function _interopRequireWildcard(e,r){if(!r&&e&&e.__esModule)return e;if(null===e||"object"!==_typeof(e)&&"function"!=typeof e)return{default:e};var t=_getRequireWildcardCache(r);if(t&&t.has(e))return t.get(e);var n={},s=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var i=s?Object.getOwnPropertyDescriptor(e,o):null;i&&(i.get||i.set)?Object.defineProperty(n,o,i):n[o]=e[o]}return n.default=e,t&&t.set(e,n),n}function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _createForOfIteratorHelper(e,r){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!t){if(Array.isArray(e)||(t=_unsupportedIterableToArray(e))||r&&e&&"number"==typeof e.length){t&&(e=t);var n=0,s=function(){};return{s:s,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,a=!1;return{s:function(){t=t.call(e)},n:function(){var e=t.next();return i=e.done,e},e:function(e){a=!0,o=e},f:function(){try{i||null==t.return||t.return()}finally{if(a)throw o}}}}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _slicedToArray(e,r){return _arrayWithHoles(e)||_iterableToArrayLimit(e,r)||_unsupportedIterableToArray(e,r)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,r){if(e){if("string"==typeof e)return _arrayLikeToArray(e,r);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(e,r):void 0}}function _arrayLikeToArray(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,n=new Array(r);t<r;t++)n[t]=e[t];return n}function _iterableToArrayLimit(e,r){var t=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=t){var n,s,o,i,a=[],c=!0,u=!1;try{if(o=(t=t.call(e)).next,0===r){if(Object(t)!==t)return;c=!1}else for(;!(c=(n=o.call(t)).done)&&(a.push(n.value),a.length!==r);c=!0);}catch(e){u=!0,s=e}finally{try{if(!c&&null!=t.return&&(i=t.return(),Object(i)!==i))return}finally{if(u)throw s}}return a}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _regeneratorRuntime(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */_regeneratorRuntime=function(){return e};var e={},r=Object.prototype,t=r.hasOwnProperty,n=Object.defineProperty||function(e,r,t){e[r]=t.value},s="function"==typeof Symbol?Symbol:{},o=s.iterator||"@@iterator",i=s.asyncIterator||"@@asyncIterator",a=s.toStringTag||"@@toStringTag";function c(e,r,t){return Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}),e[r]}try{c({},"")}catch(e){c=function(e,r,t){return e[r]=t}}function u(e,r,t,s){var o=r&&r.prototype instanceof p?r:p,i=Object.create(o.prototype),a=new k(s||[]);return n(i,"_invoke",{value:S(e,t,a)}),i}function l(e,r,t){try{return{type:"normal",arg:e.call(r,t)}}catch(e){return{type:"throw",arg:e}}}e.wrap=u;var _={};function p(){}function h(){}function d(){}var f={};c(f,o,(function(){return this}));var y=Object.getPrototypeOf,b=y&&y(y(x([])));b&&b!==r&&t.call(b,o)&&(f=b);var m=d.prototype=p.prototype=Object.create(f);function v(e){["next","throw","return"].forEach((function(r){c(e,r,(function(e){return this._invoke(r,e)}))}))}function g(e,r){function s(n,o,i,a){var c=l(e[n],e,o);if("throw"!==c.type){var u=c.arg,_=u.value;return _&&"object"==_typeof(_)&&t.call(_,"__await")?r.resolve(_.__await).then((function(e){s("next",e,i,a)}),(function(e){s("throw",e,i,a)})):r.resolve(_).then((function(e){u.value=e,i(u)}),(function(e){return s("throw",e,i,a)}))}a(c.arg)}var o;n(this,"_invoke",{value:function(e,t){function n(){return new r((function(r,n){s(e,t,r,n)}))}return o=o?o.then(n,n):n()}})}function S(e,r,t){var n="suspendedStart";return function(s,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===s)throw o;return O()}for(t.method=s,t.arg=o;;){var i=t.delegate;if(i){var a=w(i,t);if(a){if(a===_)continue;return a}}if("next"===t.method)t.sent=t._sent=t.arg;else if("throw"===t.method){if("suspendedStart"===n)throw n="completed",t.arg;t.dispatchException(t.arg)}else"return"===t.method&&t.abrupt("return",t.arg);n="executing";var c=l(e,r,t);if("normal"===c.type){if(n=t.done?"completed":"suspendedYield",c.arg===_)continue;return{value:c.arg,done:t.done}}"throw"===c.type&&(n="completed",t.method="throw",t.arg=c.arg)}}}function w(e,r){var t=r.method,n=e.iterator[t];if(void 0===n)return r.delegate=null,"throw"===t&&e.iterator.return&&(r.method="return",r.arg=void 0,w(e,r),"throw"===r.method)||"return"!==t&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+t+"' method")),_;var s=l(n,e.iterator,r.arg);if("throw"===s.type)return r.method="throw",r.arg=s.arg,r.delegate=null,_;var o=s.arg;return o?o.done?(r[e.resultName]=o.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,_):o:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,_)}function E(e){var r={tryLoc:e[0]};1 in e&&(r.catchLoc=e[1]),2 in e&&(r.finallyLoc=e[2],r.afterLoc=e[3]),this.tryEntries.push(r)}function P(e){var r=e.completion||{};r.type="normal",delete r.arg,e.completion=r}function k(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(E,this),this.reset(!0)}function x(e){if(e){var r=e[o];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,s=function r(){for(;++n<e.length;)if(t.call(e,n))return r.value=e[n],r.done=!1,r;return r.value=void 0,r.done=!0,r};return s.next=s}}return{next:O}}function O(){return{value:void 0,done:!0}}return h.prototype=d,n(m,"constructor",{value:d,configurable:!0}),n(d,"constructor",{value:h,configurable:!0}),h.displayName=c(d,a,"GeneratorFunction"),e.isGeneratorFunction=function(e){var r="function"==typeof e&&e.constructor;return!!r&&(r===h||"GeneratorFunction"===(r.displayName||r.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,c(e,a,"GeneratorFunction")),e.prototype=Object.create(m),e},e.awrap=function(e){return{__await:e}},v(g.prototype),c(g.prototype,i,(function(){return this})),e.AsyncIterator=g,e.async=function(r,t,n,s,o){void 0===o&&(o=Promise);var i=new g(u(r,t,n,s),o);return e.isGeneratorFunction(t)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},v(m),c(m,a,"Generator"),c(m,o,(function(){return this})),c(m,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var r=Object(e),t=[];for(var n in r)t.push(n);return t.reverse(),function e(){for(;t.length;){var n=t.pop();if(n in r)return e.value=n,e.done=!1,e}return e.done=!0,e}},e.values=x,k.prototype={constructor:k,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(P),!e)for(var r in this)"t"===r.charAt(0)&&t.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function n(t,n){return i.type="throw",i.arg=e,r.next=t,n&&(r.method="next",r.arg=void 0),!!n}for(var s=this.tryEntries.length-1;s>=0;--s){var o=this.tryEntries[s],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var a=t.call(o,"catchLoc"),c=t.call(o,"finallyLoc");if(a&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(a){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,r){for(var n=this.tryEntries.length-1;n>=0;--n){var s=this.tryEntries[n];if(s.tryLoc<=this.prev&&t.call(s,"finallyLoc")&&this.prev<s.finallyLoc){var o=s;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=r&&r<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=r,o?(this.method="next",this.next=o.finallyLoc,_):this.complete(i)},complete:function(e,r){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&r&&(this.next=r),_},finish:function(e){for(var r=this.tryEntries.length-1;r>=0;--r){var t=this.tryEntries[r];if(t.finallyLoc===e)return this.complete(t.completion,t.afterLoc),P(t),_}},catch:function(e){for(var r=this.tryEntries.length-1;r>=0;--r){var t=this.tryEntries[r];if(t.tryLoc===e){var n=t.completion;if("throw"===n.type){var s=n.arg;P(t)}return s}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,t){return this.delegate={iterator:x(e),resultName:r,nextLoc:t},"next"===this.method&&(this.arg=void 0),_}},e}function asyncGeneratorStep(e,r,t,n,s,o,i){try{var a=e[o](i),c=a.value}catch(e){return void t(e)}a.done?r(c):Promise.resolve(c).then(n,s)}function _asyncToGenerator(e){return function(){var r=this,t=arguments;return new Promise((function(n,s){var o=e.apply(r,t);function i(e){asyncGeneratorStep(o,n,s,i,a,"next",e)}function a(e){asyncGeneratorStep(o,n,s,i,a,"throw",e)}i(void 0)}))}}function ownKeys(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,n)}return t}function _objectSpread(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?ownKeys(Object(t),!0).forEach((function(r){_defineProperty(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}function _defineProperty(e,r,t){return(r=_toPropertyKey(r))in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,_toPropertyKey(n.key),n)}}function _createClass(e,r,t){return r&&_defineProperties(e.prototype,r),t&&_defineProperties(e,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var r=_toPrimitive(e,"string");return"symbol"===_typeof(r)?r:String(r)}function _toPrimitive(e,r){if("object"!==_typeof(e)||null===e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,r||"default");if("object"!==_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(e)}var jsonSerializer=new _JsonSerializer.JsonSerializer,Wampy=function(){function e(r,t){_classCallCheck(this,e),this.version="v7.0.2",this._url="string"==typeof r?r:null,this._protocols=["wamp.2.json"],this._wamp_features={agent:"Wampy.js "+this.version,roles:{publisher:{features:{subscriber_blackwhite_listing:!0,publisher_exclusion:!0,publisher_identification:!0,payload_passthru_mode:!0}},subscriber:{features:{pattern_based_subscription:!0,publication_trustlevels:!0,publisher_identification:!0,payload_passthru_mode:!0}},caller:{features:{caller_identification:!0,progressive_call_results:!0,call_canceling:!0,call_timeout:!0,payload_passthru_mode:!0}},callee:{features:{caller_identification:!0,call_trustlevels:!0,pattern_based_registration:!0,shared_registration:!0,payload_passthru_mode:!0}}}},this._cache={sessionId:null,reqId:0,server_wamp_features:{roles:{}},isSayingGoodbye:!1,opStatus:{code:0,error:null,reqId:0},timer:null,reconnectingAttempts:0,connectPromise:null,closePromise:null},this._ws=null,this._wsQueue=[],this._requests={},this._calls={},this._subscriptionsById=new Map,this._subscriptionsByKey=new Map,this._rpcRegs={},this._rpcNames=new Set,this._options={debug:!1,logger:null,autoReconnect:!0,reconnectInterval:2e3,maxRetries:25,realm:null,helloCustomDetails:null,uriValidation:"strict",authid:null,authmethods:[],authextra:{},authPlugins:{},authMode:"manual",onChallenge:null,onClose:null,onError:null,onReconnect:null,onReconnectSuccess:null,ws:null,additionalHeaders:null,wsRequestOptions:null,serializer:jsonSerializer,payloadSerializers:{json:jsonSerializer}},this._isPlainObject(t)?this._options=_objectSpread(_objectSpread({},this._options),t):this._isPlainObject(r)&&(this._options=_objectSpread(_objectSpread({},this._options),r))}var r,t,n,s,o,i,a,c,u,l,_,p,h,d,f,y,b,m,v,g,S,w;return _createClass(e,[{key:"_log",value:function(){if(this._options.debug){for(var e=arguments.length,r=new Array(e),t=0;t<e;t++)r[t]=arguments[t];return this._options.logger?this._options.logger(r):console.log("[wampy]",r)}}},{key:"_getReqId",value:function(){return++this._cache.reqId}},{key:"_isPlainObject",value:function(e){var r=null==e?void 0:e.constructor,t=null==r?void 0:r.prototype;return"[object Object]"===Object.prototype.toString.call(e)&&"function"==typeof r&&"[object Object]"===Object.prototype.toString.call(t)&&Object.hasOwnProperty.call(t,"isPrototypeOf")}},{key:"_setWsProtocols",value:function(){this._protocols=["wamp.2."+this._options.serializer.protocol]}},{key:"_fillOpStatusByError",value:function(e){this._cache.opStatus={code:e.code,error:e,reqId:0}}},{key:"_preReqChecks",value:function(e,r){if(this._cache.sessionId&&!this._cache.server_wamp_features.roles[r]){var t={dealer:new Errors.NoDealerError,broker:new Errors.NoBrokerError};return this._fillOpStatusByError(t[r]),!1}return!(e&&!this._validateURI(e.topic,e.patternBased,e.allowWAMP))||(this._fillOpStatusByError(new Errors.UriError),!1)}},{key:"_checkRouterFeature",value:function(e,r){return!0===this._cache.server_wamp_features.roles[e].features[r]||(this._fillOpStatusByError(new Errors.FeatureNotSupportedError(e,r)),!1)}},{key:"_checkPPTOptions",value:function(e,r){return this._checkRouterFeature(e,"payload_passthru_mode")?r.ppt_scheme.search(/^(wamp$|mqtt$|x_)/)<0?(this._fillOpStatusByError(new Errors.PPTInvalidSchemeError),!1):!("wamp"===r.ppt_scheme&&!_constants.E2EE_SERIALIZERS.includes(r.ppt_serializer))||(this._fillOpStatusByError(new Errors.PPTSerializerInvalidError),!1):(this._fillOpStatusByError(new Errors.PPTNotSupportedError),!1)}},{key:"_validateURI",value:function(e,r,t){var n,s,o="strict"===this._options.uriValidation,i="loose"===this._options.uriValidation;return!(!o&&!i||e.startsWith("wamp.")&&!t)&&(o?(n=/^(\w+\.)*(\w+)$/,s=/^(\w+\.{1,2})*(\w+)$/):i&&(n=/^([^\s.#]+\.)*([^\s.#]+)$/,s=/^([^\s.#]+\.{1,2})*([^\s.#]+)$/),(r?s:n).test(e))}},{key:"_packPPTPayload",value:function(e,r){var t=(null==e?void 0:e.argsList)&&!Array.isArray(e.argsList),n=(null==e?void 0:e.argsDict)&&!this._isPlainObject(e.argsDict);if(t||n){var s=t?e.argsList:e.argsDict;return this._fillOpStatusByError(new Errors.InvalidParamError(s)),{err:!0,payloadItems:[]}}var o,i,a=this._isPlainObject(e),c=e.argsList,u=e.argsDict;!a||c||u?a?(o=c,i=u):o=Array.isArray(e)?e:[e]:i=e;var l=[];if(!r.ppt_scheme)return o&&l.push(o),i&&(o||l.push([]),l.push(i)),{err:!1,payloadItems:l};var _={args:o,kwargs:i},p=_;if(r.ppt_serializer&&"native"!==r.ppt_serializer){var h=this._options.payloadSerializers[r.ppt_serializer];if(!h)return this._fillOpStatusByError(new Errors.PPTSerializerInvalidError),{err:!0,payloadItems:l};try{p=h.encode(_)}catch(e){return this._fillOpStatusByError(new Errors.PPTSerializationError),{err:!0,payloadItems:l}}}return l.push([p]),{err:!1,payloadItems:l}}},{key:"_unpackPPTPayload",value:function(e,r,t){var n;if(!this._checkPPTOptions(e,t))return{err:this._cache.opStatus.error};if(t.ppt_serializer&&"native"!==t.ppt_serializer){var s=this._options.payloadSerializers[t.ppt_serializer];if(!s)return{err:new Errors.PPTSerializerInvalidError};try{n=s.decode(r)}catch(e){return{err:new Errors.PPTSerializationError}}}else n=r;return{err:!1,args:n.args,kwargs:n.kwargs}}},{key:"_encode",value:function(e){try{return this._options.serializer.encode(e)}catch(e){this._hardClose("wamp.error.protocol_violation","Can not encode message",!0)}}},{key:"_decode",value:function(e){try{return this._options.serializer.decode(e)}catch(e){this._hardClose("wamp.error.protocol_violation","Can not decode received message")}}},{key:"_hardClose",value:function(e,r){var t=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this._log(r),this._wsQueue=[],t||this._send([_constants.WAMP_MSG_SPEC.ABORT,{message:r},e]);var n=new Errors.ProtocolViolationError(e,r);this._cache.connectPromise&&(this._cache.connectPromise.onError(n),this._cache.connectPromise=null),this._options.onError&&this._options.onError(n),this._ws.close()}},{key:"_send",value:function(e){if(e&&this._wsQueue.push(this._encode(e)),this._ws&&1===this._ws.readyState&&this._cache.sessionId)for(;this._wsQueue.length;)this._ws.send(this._wsQueue.shift())}},{key:"_resetState",value:function(){this._wsQueue=[],this._subscriptionsById.clear(),this._subscriptionsByKey.clear(),this._requests={},this._calls={},this._rpcRegs={},this._rpcNames=new Set,this._cache={reqId:0,reconnectingAttempts:0,opStatus:_constants.SUCCESS,closePromise:null,connectPromise:null}}},{key:"_initWsCallbacks",value:function(){var e=this;this._ws.onopen=function(){return e._wsOnOpen()},this._ws.onclose=function(r){return e._wsOnClose(r)},this._ws.onmessage=function(r){return e._wsOnMessage(r)},this._ws.onerror=function(r){return e._wsOnError(r)}}},{key:"_wsOnOpen",value:function(){var e,r,t=this._options,n=t.helloCustomDetails,s=t.authmethods,o=t.authid,i=t.authextra,a=t.serializer,c=t.onError,u=t.realm,l=null===(e=this._ws.protocol)||void 0===e||null===(r=e.split("."))||void 0===r?void 0:r[2],_=l===a.protocol;if(this._log('Websocket connected. Server has chosen protocol: "'.concat(l,'"')),!_)if("json"===l)this._options.serializer=new _JsonSerializer.JsonSerializer;else{var p=new Errors.NoSerializerAvailableError;this._fillOpStatusByError(p),this._cache.connectPromise&&(this._cache.connectPromise.onError(p),this._cache.connectPromise=null),c&&c(p)}a.isBinary&&(this._ws.binaryType="arraybuffer");var h=_objectSpread(_objectSpread(_objectSpread({},n),this._wamp_features),o?{authid:o,authmethods:s,authextra:i}:{}),d=this._encode([_constants.WAMP_MSG_SPEC.HELLO,u,h]);d&&this._ws.send(d)}},{key:"_wsOnClose",value:function(e){var r=this;this._log("websocket disconnected. Info: ",e),(this._cache.sessionId||this._cache.reconnectingAttempts)&&this._options.autoReconnect&&(0===this._options.maxRetries||this._cache.reconnectingAttempts<this._options.maxRetries)&&!this._cache.isSayingGoodbye?(this._cache.sessionId=null,this._cache.timer=setTimeout((function(){r._wsReconnect()}),this._options.reconnectInterval)):(this._options.onClose?this._options.onClose():this._cache.closePromise&&(this._cache.closePromise.onSuccess(),this._cache.closePromise=null),this._resetState(),this._ws=null)}},{key:"_wsOnMessage",value:(w=_asyncToGenerator(_regeneratorRuntime().mark((function e(r){var t,n,s,o,i,a,c,u=this;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this._decode(r.data),this._log("websocket message received: ",n),s=n[0],_defineProperty(t={},_constants.WAMP_MSG_SPEC.WELCOME,(function(){return u._onWelcomeMessage(n)})),_defineProperty(t,_constants.WAMP_MSG_SPEC.ABORT,(function(){return u._onAbortMessage(n)})),_defineProperty(t,_constants.WAMP_MSG_SPEC.CHALLENGE,(function(){return u._onChallengeMessage(n)})),_defineProperty(t,_constants.WAMP_MSG_SPEC.GOODBYE,(function(){return u._onGoodbyeMessage(n)})),_defineProperty(t,_constants.WAMP_MSG_SPEC.ERROR,(function(){return u._onErrorMessage(n)})),_defineProperty(t,_constants.WAMP_MSG_SPEC.SUBSCRIBED,(function(){return u._onSubscribedMessage(n)})),_defineProperty(t,_constants.WAMP_MSG_SPEC.UNSUBSCRIBED,(function(){return u._onUnsubscribedMessage(n)})),_defineProperty(t,_constants.WAMP_MSG_SPEC.PUBLISHED,(function(){return u._onPublishedMessage(n)})),_defineProperty(t,_constants.WAMP_MSG_SPEC.EVENT,(function(){return u._onEventMessage(n)})),_defineProperty(t,_constants.WAMP_MSG_SPEC.RESULT,(function(){return u._onResultMessage(n)})),_defineProperty(t,_constants.WAMP_MSG_SPEC.REGISTERED,(function(){return u._onRegisteredMessage(n)})),_defineProperty(t,_constants.WAMP_MSG_SPEC.UNREGISTERED,(function(){return u._onUnregisteredMessage(n)})),_defineProperty(t,_constants.WAMP_MSG_SPEC.INVOCATION,(function(){return u._onInvocationMessage(n)})),i="wamp.error.protocol_violation",o=t[s]){e.next=8;break}return e.abrupt("return",this._hardClose(i,'Received non-compliant WAMP message: "'.concat(s,'"')));case 8:if(a=[_constants.WAMP_MSG_SPEC.WELCOME,_constants.WAMP_MSG_SPEC.CHALLENGE].includes(s),c=!a&&s!==_constants.WAMP_MSG_SPEC.ABORT,!a||!this._cache.sessionId){e.next=12;break}return e.abrupt("return",this._hardClose(i,'Received message "'.concat(s,'" after session was established')));case 12:if(!c||this._cache.sessionId){e.next=14;break}return e.abrupt("return",this._hardClose(i,'Received message "'.concat(s,'" before session was established')));case 14:return e.next=16,o();case 16:case"end":return e.stop()}}),e,this)}))),function(e){return w.apply(this,arguments)})},{key:"_onWelcomeMessage",value:(S=_asyncToGenerator(_regeneratorRuntime().mark((function e(r){var t,n,s;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=_slicedToArray(r,3),n=t[1],s=t[2],this._cache.sessionId=n,this._cache.server_wamp_features=s,!this._cache.reconnectingAttempts){e.next=12;break}if(this._cache.reconnectingAttempts=0,!this._options.onReconnectSuccess){e.next=8;break}return e.next=8,this._options.onReconnectSuccess(s);case 8:this._renewSubscriptions(),this._renewRegistrations(),e.next=14;break;case 12:this._cache.connectPromise.onSuccess(s),this._cache.connectPromise=null;case 14:this._send();case 15:case"end":return e.stop()}}),e,this)}))),function(e){return S.apply(this,arguments)})},{key:"_onAbortMessage",value:(g=_asyncToGenerator(_regeneratorRuntime().mark((function e(r){var t,n,s,o;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=_slicedToArray(r,3),n=t[1],s=t[2],o=new Errors.AbortError({error:s,details:n}),this._cache.connectPromise&&(this._cache.connectPromise.onError(o),this._cache.connectPromise=null),!this._options.onError){e.next=6;break}return e.next=6,this._options.onError(o);case 6:this._ws.close();case 7:case"end":return e.stop()}}),e,this)}))),function(e){return g.apply(this,arguments)})},{key:"_onChallengeMessage",value:(v=_asyncToGenerator(_regeneratorRuntime().mark((function e(r){var t,n,s,o,i,a,c,u,l,_,p,h,d;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=_slicedToArray(r,3),n=t[1],s=t[2],i=this._options,a=i.authid,c=i.authMode,u=i.onChallenge,l=i.onError,_=i.authPlugins,!a||"manual"!==c||"function"!=typeof u){e.next=6;break}o=new Promise((function(e){e(u(n,s))})),e.next=17;break;case 6:if(!a||"auto"!==c||"function"!=typeof _[n]){e.next=10;break}o=new Promise((function(e){e(_[n](n,s))})),e.next=17;break;case 10:if(p=new Errors.NoCRACallbackOrIdError,this._fillOpStatusByError(p),this._ws.send(this._encode([_constants.WAMP_MSG_SPEC.ABORT,{message:p.message},"wamp.error.cannot_authenticate"])),!l){e.next=16;break}return e.next=16,l(p);case 16:return e.abrupt("return",this._ws.close());case 17:return e.prev=17,e.next=20,o;case 20:h=e.sent,this._ws.send(this._encode([_constants.WAMP_MSG_SPEC.AUTHENTICATE,h,{}])),e.next=33;break;case 24:if(e.prev=24,e.t0=e.catch(17),d=new Errors.ChallengeExceptionError,this._fillOpStatusByError(d),this._ws.send(this._encode([_constants.WAMP_MSG_SPEC.ABORT,{message:d.message},"wamp.error.cannot_authenticate"])),!l){e.next=32;break}return e.next=32,l(d);case 32:this._ws.close();case 33:case"end":return e.stop()}}),e,this,[[17,24]])}))),function(e){return v.apply(this,arguments)})},{key:"_onGoodbyeMessage",value:(m=_asyncToGenerator(_regeneratorRuntime().mark((function e(){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this._cache.isSayingGoodbye||(this._cache.isSayingGoodbye=!0,this._send([_constants.WAMP_MSG_SPEC.GOODBYE,{},"wamp.close.goodbye_and_out"])),this._cache.sessionId=null,this._ws.close();case 3:case"end":return e.stop()}}),e,this)}))),function(){return m.apply(this,arguments)})},{key:"_onErrorMessage",value:(b=_asyncToGenerator(_regeneratorRuntime().mark((function e(r){var t,n,s,o,i,a,c,u,l,_,p,h,d;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=_slicedToArray(r,7),s=n[1],o=n[2],i=n[3],a=n[4],c=n[5],u=n[6],l={error:a,details:i,argsList:c,argsDict:u},_defineProperty(t={},_constants.WAMP_MSG_SPEC.SUBSCRIBE,new Errors.SubscribeError(l)),_defineProperty(t,_constants.WAMP_MSG_SPEC.UNSUBSCRIBE,new Errors.UnsubscribeError(l)),_defineProperty(t,_constants.WAMP_MSG_SPEC.PUBLISH,new Errors.PublishError(l)),_defineProperty(t,_constants.WAMP_MSG_SPEC.REGISTER,new Errors.RegisterError(l)),_defineProperty(t,_constants.WAMP_MSG_SPEC.UNREGISTER,new Errors.UnregisterError(l)),_defineProperty(t,_constants.WAMP_MSG_SPEC.CALL,new Errors.CallError(l)),_=t[s]){e.next=6;break}return e.abrupt("return",this._hardClose("wamp.error.protocol_violation","Received invalid ERROR message"));case 6:if(s!==_constants.WAMP_MSG_SPEC.CALL){e.next=13;break}if(null===(p=this._calls[o])||void 0===p||!p.onError){e.next=10;break}return e.next=10,this._calls[o].onError(_);case 10:delete this._calls[o],e.next=17;break;case 13:if(null===(h=this._requests[o])||void 0===h||null===(d=h.callbacks)||void 0===d||!d.onError){e.next=16;break}return e.next=16,this._requests[o].callbacks.onError(_);case 16:delete this._requests[o];case 17:case"end":return e.stop()}}),e,this)}))),function(e){return b.apply(this,arguments)})},{key:"_onSubscribedMessage",value:(y=_asyncToGenerator(_regeneratorRuntime().mark((function e(r){var t,n,s,o,i,a,c,u,l;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=_slicedToArray(r,3),n=t[1],s=t[2],this._requests[n]){e.next=3;break}return e.abrupt("return");case 3:if(o=this._requests[n],i=o.topic,a=o.advancedOptions,c=o.callbacks,u={id:s,topic:i,advancedOptions:a,callbacks:[c.onEvent]},l=this._getSubscriptionKey(i,a),this._subscriptionsById.set(s,u),this._subscriptionsByKey.set(l,u),!c.onSuccess){e.next=11;break}return e.next=11,c.onSuccess({topic:i,requestId:n,subscriptionId:s,subscriptionKey:l});case 11:delete this._requests[n];case 12:case"end":return e.stop()}}),e,this)}))),function(e){return y.apply(this,arguments)})},{key:"_onUnsubscribedMessage",value:(f=_asyncToGenerator(_regeneratorRuntime().mark((function e(r){var t,n,s,o,i,a,c,u;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=_slicedToArray(r,2),n=t[1],this._requests[n]){e.next=3;break}return e.abrupt("return");case 3:if(s=this._requests[n],o=s.topic,i=s.advancedOptions,a=s.callbacks,c=this._getSubscriptionKey(o,i),u=this._subscriptionsByKey.get(c).id,this._subscriptionsByKey.delete(c),this._subscriptionsById.delete(u),!a.onSuccess){e.next=11;break}return e.next=11,a.onSuccess({topic:o,requestId:n});case 11:delete this._requests[n];case 12:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"_onPublishedMessage",value:(d=_asyncToGenerator(_regeneratorRuntime().mark((function e(r){var t,n,s,o,i,a;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=_slicedToArray(r,3),n=t[1],s=t[2],this._requests[n]){e.next=3;break}return e.abrupt("return");case 3:if(o=this._requests[n],i=o.topic,null==(a=o.callbacks)||!a.onSuccess){e.next=7;break}return e.next=7,a.onSuccess({topic:i,requestId:n,publicationId:s});case 7:delete this._requests[n];case 8:case"end":return e.stop()}}),e,this)}))),function(e){return d.apply(this,arguments)})},{key:"_onEventMessage",value:(h=_asyncToGenerator(_regeneratorRuntime().mark((function e(r){var t,n,s,o,i,a,c,u,l,_,p,h;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=_slicedToArray(r,6),n=t[1],t[2],s=t[3],o=t[4],i=t[5],a=this._subscriptionsById.get(n)){e.next=4;break}return e.abrupt("return");case 4:if(c=o,u=i,!s.ppt_scheme){e.next=13;break}if(l=o[0],!(_=this._unpackPPTPayload("broker",l,s)).err){e.next=11;break}return e.abrupt("return",this._log(_.err.message));case 11:c=_.args,u=_.kwargs;case 13:return p={details:s,argsList:c,argsDict:u},h=a.callbacks.map((function(e){return e(p)})),e.next=17,Promise.all(h);case 17:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"_onResultMessage",value:(p=_asyncToGenerator(_regeneratorRuntime().mark((function e(r){var t,n,s,o,i,a,c,u,l,_;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=_slicedToArray(r,5),n=t[1],s=t[2],o=t[3],i=t[4],this._calls[n]){e.next=3;break}return e.abrupt("return");case 3:if(a=o,c=i,!s.ppt_scheme){e.next=17;break}if(u=o[0],!(l=this._unpackPPTPayload("dealer",u,s)).err){e.next=15;break}return this._log(l.err.message),this._cache.opStatus=l.err,e.next=13,this._calls[n].onError(new Errors.CallError({details:s,error:"wamp.error.invocation_exception",argsList:[l.err.message],argsDict:null}));case 13:return delete this._calls[n],e.abrupt("return");case 15:a=l.args,c=l.kwargs;case 17:if(_={details:s,argsList:a,argsDict:c},!s.progress){e.next=23;break}return e.next=21,this._calls[n].onProgress(_);case 21:e.next=26;break;case 23:return e.next=25,this._calls[n].onSuccess(_);case 25:delete this._calls[n];case 26:case"end":return e.stop()}}),e,this)}))),function(e){return p.apply(this,arguments)})},{key:"_onRegisteredMessage",value:(_=_asyncToGenerator(_regeneratorRuntime().mark((function e(r){var t,n,s,o,i,a;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=_slicedToArray(r,3),n=t[1],s=t[2],this._requests[n]){e.next=3;break}return e.abrupt("return");case 3:if(o=this._requests[n],i=o.topic,a=o.callbacks,this._rpcRegs[s]={id:s,callbacks:[a.rpc]},this._rpcRegs[i]=this._rpcRegs[s],this._rpcNames.add(i),null==a||!a.onSuccess){e.next=10;break}return e.next=10,a.onSuccess({topic:i,requestId:n,registrationId:s});case 10:delete this._requests[n];case 11:case"end":return e.stop()}}),e,this)}))),function(e){return _.apply(this,arguments)})},{key:"_onUnregisteredMessage",value:(l=_asyncToGenerator(_regeneratorRuntime().mark((function e(r){var t,n,s,o,i;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=_slicedToArray(r,2),n=t[1],this._requests[n]){e.next=3;break}return e.abrupt("return");case 3:if(s=this._requests[n],o=s.topic,i=s.callbacks,delete this._rpcRegs[this._rpcRegs[o].id],delete this._rpcRegs[o],this._rpcNames.has(o)&&this._rpcNames.delete(o),null==i||!i.onSuccess){e.next=10;break}return e.next=10,i.onSuccess({topic:o,requestId:n});case 10:delete this._requests[n];case 11:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"_onInvocationMessage",value:(u=_asyncToGenerator(_regeneratorRuntime().mark((function e(r){var t,n,s,o,i,a,c,u,l,_,p,h,d,f,y=this;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=_slicedToArray(r,6),n=t[1],s=t[2],o=t[3],i=t[4],a=t[5],c=this,u=function(e){var r=e.error,t=e.details,s=e.argsList,o=e.argsDict,i=[_constants.WAMP_MSG_SPEC.ERROR,_constants.WAMP_MSG_SPEC.INVOCATION,n,t||{},r||"wamp.error.invocation_exception"];Array.isArray(s)&&i.push(s),c._isPlainObject(o)&&(Array.isArray(s)||i.push([]),i.push(o)),c._send(i)},this._rpcRegs[s]){e.next=6;break}return this._log(_constants.WAMP_ERROR_MSG.NON_EXIST_RPC_INVOCATION),e.abrupt("return",u({error:"wamp.error.no_such_procedure"}));case 6:if(l=i,_=a,null==o||!o.ppt_scheme){e.next=18;break}if(p=i[0],!(h=this._unpackPPTPayload("dealer",p,o)).err){e.next=16;break}if(this._log(h.err.message),!(h.err instanceof Errors.PPTNotSupportedError)){e.next=15;break}return e.abrupt("return",this._hardClose("wamp.error.protocol_violation","Received INVOCATION in PPT Mode, while Dealer didn't announce it"));case 15:return e.abrupt("return",u({details:o,error:"wamp.error.invocation_exception",argsList:[h.err.message]}));case 16:l=h.args,_=h.kwargs;case 18:return d=function(e){var r=(null==e?void 0:e.options)||{},t=r.ppt_scheme,s=r.ppt_serializer,o=r.ppt_cipher,i=r.ppt_keyid;if(t&&!y._checkPPTOptions("dealer",r))return y._cache.opStatus.error instanceof Errors.PPTNotSupportedError?y._hardClose("wamp.error.protocol_violation","Trying to send YIELD in PPT Mode, while Dealer didn't announce it"):u({details:r,error:"wamp.error.invalid_option",argsList:[y._cache.opStatus.error.message]});var a=e?y._packPPTPayload(e,r):{},l=a.err,_=a.payloadItems;if(l)return u({details:r,error:"wamp.error.invocation_exception",argsList:[y._cache.opStatus.error.message]});var p=_objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread({},r),t?{ppt_scheme:t}:{}),s?{ppt_serializer:s}:{}),o?{ppt_cipher:o}:{}),i?{ppt_keyid:i}:{});c._send([_constants.WAMP_MSG_SPEC.YIELD,n,p].concat(_toConsumableArray(_||[])))},e.prev=19,e.next=22,this._rpcRegs[s].callbacks[0]({details:o,argsList:l,argsDict:_,result_handler:d,error_handler:u});case 22:f=e.sent,d(f),e.next=29;break;case 26:e.prev=26,e.t0=e.catch(19),u(e.t0);case 29:case"end":return e.stop()}}),e,this,[[19,26]])}))),function(e){return u.apply(this,arguments)})},{key:"_wsOnError",value:function(e){this._log("websocket error");var r=new Errors.WebsocketError(e);this._cache.connectPromise&&(this._cache.connectPromise.onError(r),this._cache.connectPromise=null),this._options.onError&&this._options.onError(r)}},{key:"_wsReconnect",value:function(){this._log("websocket reconnecting..."),this._options.onReconnect&&this._options.onReconnect(),this._cache.reconnectingAttempts++,this._ws=(0,_utils.getWebSocket)({url:this._url,protocols:this._protocols,options:this._options}),this._initWsCallbacks()}},{key:"_renewSubscriptions",value:function(){var e,r=this,t=new Map(this._subscriptionsById);this._subscriptionsById.clear(),this._subscriptionsByKey.clear(),t.forEach((function(t){for(e=t.callbacks.length;e--;)r.subscribe(t.topic,t.callbacks[e],t.advancedOptions)}))}},{key:"_renewRegistrations",value:function(){var e=this._rpcRegs,r=this._rpcNames;this._rpcRegs={},this._rpcNames=new Set;var t,n=_createForOfIteratorHelper(r);try{for(n.s();!(t=n.n()).done;){var s=t.value;this.register(s,e[s].callbacks[0])}}catch(e){n.e(e)}finally{n.f()}}},{key:"_getSubscriptionKey",value:function(e,r){return"".concat(e,"-").concat(JSON.stringify(r))}},{key:"options",value:function(e){return console.warn("Wampy.options() is deprecated, please use Wampy.getOptions() or Wampy.setOptions() instead"),void 0===e?this._options:this._isPlainObject(e)?(this._options=_objectSpread(_objectSpread({},this._options),e),this):void 0}},{key:"getOptions",value:function(){return this._options}},{key:"setOptions",value:function(e){if(this._isPlainObject(e))return this._options=_objectSpread(_objectSpread({},this._options),e),this}},{key:"getOpStatus",value:function(){return this._cache.opStatus}},{key:"getSessionId",value:function(){return this._cache.sessionId}},{key:"connect",value:(c=_asyncToGenerator(_regeneratorRuntime().mark((function e(r){var t,n,s,o,i;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r&&(this._url=r),this._options.realm){e.next=5;break}throw t=new Errors.NoRealmError,this._fillOpStatusByError(t),t;case 5:if(!((n=(this._options.authid?1:0)+(Array.isArray(this._options.authmethods)&&this._options.authmethods.length?1:0)+("function"==typeof this._options.onChallenge||Object.keys(this._options.authPlugins).length?1:0))>0&&n<3)){e.next=10;break}throw s=new Errors.NoCRACallbackOrIdError,this._fillOpStatusByError(s),s;case 10:if(this._setWsProtocols(),this._ws=(0,_utils.getWebSocket)({url:this._url,protocols:this._protocols,options:this._options}),this._ws){e.next=16;break}throw o=new Errors.NoWsOrUrlError,this._fillOpStatusByError(o),o;case 16:return this._initWsCallbacks(),i=(0,_utils.getNewPromise)(),this._cache.connectPromise=i,e.abrupt("return",i.promise);case 20:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"disconnect",value:(a=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var r;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._cache.sessionId){e.next=9;break}return r=(0,_utils.getNewPromise)(),this._cache.opStatus=_constants.SUCCESS,this._cache.closePromise=r,this._cache.isSayingGoodbye=!0,this._send([_constants.WAMP_MSG_SPEC.GOODBYE,{},"wamp.close.system_shutdown"]),e.abrupt("return",r.promise);case 9:this._ws&&this._ws.close();case 10:return e.abrupt("return",!0);case 11:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"abort",value:function(){return this._cache.sessionId||1!==this._ws.readyState||(this._send([_constants.WAMP_MSG_SPEC.ABORT,{},"wamp.error.abort"]),this._cache.sessionId=null),this._ws.close(),this._cache.opStatus=_constants.SUCCESS,this}},{key:"subscribe",value:(i=_asyncToGenerator(_regeneratorRuntime().mark((function e(r,t,n){var s,o,i,a,c,u,l,_,p,h;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((s=this._isPlainObject(n))||void 0===n){e.next=5;break}throw o=new Errors.InvalidParamError("advancedOptions"),this._fillOpStatusByError(o),o;case 5:if(a=!1,!s||!Object.prototype.hasOwnProperty.call(n,"match")){e.next=13;break}if(["prefix","wildcard"].includes(n.match)){e.next=11;break}throw c=new Errors.InvalidParamError("match"),this._fillOpStatusByError(c),c;case 11:i=n.match,a=!0;case 13:if(this._preReqChecks({topic:r,patternBased:a,allowWAMP:!0},"broker")){e.next=15;break}throw this._cache.opStatus.error;case 15:if("function"==typeof t){e.next=19;break}throw u=new Errors.NoCallbackError,this._fillOpStatusByError(u),u;case 19:if(l=this._getSubscriptionKey(r,n),!((_=this._subscriptionsByKey.get(l))&&_.callbacks.length>0)){e.next=24;break}return _.callbacks.includes(t)||_.callbacks.push(t),e.abrupt("return",{topic:r,requestId:0,subscriptionId:_.id,subscriptionKey:l});case 24:return p=this._getReqId(),(h=(0,_utils.getNewPromise)()).onEvent=t,this._requests[p]={topic:r,callbacks:h,advancedOptions:n},this._send([_constants.WAMP_MSG_SPEC.SUBSCRIBE,p,{match:i},r]),this._cache.opStatus=_objectSpread(_objectSpread({},_constants.SUCCESS),{},{reqId:p||0}),e.abrupt("return",h.promise);case 31:case"end":return e.stop()}}),e,this)}))),function(e,r,t){return i.apply(this,arguments)})},{key:"unsubscribe",value:(o=_asyncToGenerator(_regeneratorRuntime().mark((function e(r,t){var n,s,o;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._preReqChecks(null,"broker")){e.next=2;break}throw this._cache.opStatus.error;case 2:if(n=this._subscriptionsById.get(r)||this._subscriptionsByKey.get(r)){e.next=7;break}throw s=new Errors.NonExistUnsubscribeError,this._fillOpStatusByError(s),s;case 7:if(n.callbacks="function"==typeof t?n.callbacks.filter((function(e){return e!==t})):[],!(n.callbacks.length>0)){e.next=12;break}return this._cache.opStatus=_constants.SUCCESS,e.abrupt("return",!0);case 12:return o=this._getReqId(),this._requests[o]={topic:n.topic,callbacks:(0,_utils.getNewPromise)()},this._send([_constants.WAMP_MSG_SPEC.UNSUBSCRIBE,o,n.id]),this._cache.opStatus=_objectSpread(_objectSpread({},_constants.SUCCESS),{},{reqId:o}),e.abrupt("return",this._requests[o].callbacks.promise);case 17:case"end":return e.stop()}}),e,this)}))),function(e,r){return o.apply(this,arguments)})},{key:"publish",value:(s=_asyncToGenerator(_regeneratorRuntime().mark((function e(r,t,n){var s,o,i,a,c,u,l,_,p,h,d,f,y,b,m,v;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._preReqChecks({topic:r,patternBased:!1,allowWAMP:!1},"broker")){e.next=2;break}throw this._cache.opStatus.error;case 2:if(s=this._isPlainObject(n),!n||s){e.next=7;break}throw o=new Errors.InvalidParamError("advancedOptions"),this._fillOpStatusByError(o),o;case 7:if(i={},a=function(e,r){if(n[e])if(Array.isArray(n[e])&&n[e].length)i[e]=n[e];else{if(_typeof(n[e])!==r)return!1;i[e]=[n[e]]}return!0},!s||a("exclude","number")&&a("exclude_authid","string")&&a("exclude_authrole","string")&&a("eligible","number")&&a("eligible_authid","string")&&a("eligible_authrole","string")){e.next=13;break}throw c=new Errors.InvalidParamError("advancedOptions"),this._fillOpStatusByError(c),c;case 13:if(l=(u=n||{}).ppt_scheme,_=u.ppt_serializer,p=u.ppt_cipher,h=u.ppt_keyid,d=u.exclude_me,f=u.disclose_me,!l||this._checkPPTOptions("broker",n)){e.next=16;break}throw this._cache.opStatus.error;case 16:if(i=_objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread({acknowledge:!0},i),l?{ppt_scheme:l}:{}),l?{ppt_scheme:l}:{}),_?{ppt_serializer:_}:{}),p?{ppt_cipher:p}:{}),h?{ppt_keyid:h}:{}),d?{exclude_me:d}:{}),f?{disclose_me:f}:{}),y=t?this._packPPTPayload(t,i):{},b=y.err,m=y.payloadItems,v=this._getReqId(),!b){e.next=21;break}throw this._cache.opStatus.error;case 21:return this._requests[v]={topic:r,callbacks:(0,_utils.getNewPromise)()},this._cache.opStatus=_objectSpread(_objectSpread({},_constants.SUCCESS),{},{reqId:v}),this._send([_constants.WAMP_MSG_SPEC.PUBLISH,v,i,r].concat(_toConsumableArray(m||[]))),e.abrupt("return",this._requests[v].callbacks.promise);case 25:case"end":return e.stop()}}),e,this)}))),function(e,r,t){return s.apply(this,arguments)})},{key:"call",value:(n=_asyncToGenerator(_regeneratorRuntime().mark((function e(r,t,n){var s,o,i,a,c,u,l,_,p,h,d,f,y,b,m,v,g,S;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._preReqChecks({topic:r,patternBased:!1,allowWAMP:!0},"dealer")){e.next=2;break}throw this._cache.opStatus.error;case 2:if(!n||this._isPlainObject(n)){e.next=6;break}throw s=new Errors.InvalidParamError("advancedOptions"),this._fillOpStatusByError(s),s;case 6:if(i=(o=n||{}).timeout,a=o.progress_callback,c=o.disclose_me,l=a&&"function"!=typeof a,!(u=i&&"number"!=typeof i)&&!l){e.next=14;break}throw _=u?"timeout":"progress_callback",s=new Errors.InvalidParamError(_),this._fillOpStatusByError(s),s;case 14:if(h=(p=n||{}).ppt_scheme,d=p.ppt_serializer,f=p.ppt_cipher,y=p.ppt_keyid,!h||this._checkPPTOptions("dealer",n)){e.next=17;break}throw this._cache.opStatus.error;case 17:do{b=this._getReqId()}while(b in this._calls);if(m=_objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread({},a?{receive_progress:!0}:{}),c?{disclose_me:!0}:{}),i?{timeout:i}:{}),h?{ppt_scheme:h}:{}),d?{ppt_serializer:d}:{}),f?{ppt_cipher:f}:{}),y?{ppt_keyid:y}:{}),v=t?this._packPPTPayload(t,m):{},g=v.err,S=v.payloadItems,!g){e.next=22;break}throw this._cache.opStatus.error;case 22:return this._send([_constants.WAMP_MSG_SPEC.CALL,b,m,r].concat(_toConsumableArray(S||[]))),this._cache.opStatus=_objectSpread(_objectSpread({},_constants.SUCCESS),{},{reqId:b}),this._calls[b]=(0,_utils.getNewPromise)(),a&&(this._calls[b].onProgress=a),e.abrupt("return",this._calls[b].promise);case 27:case"end":return e.stop()}}),e,this)}))),function(e,r,t){return n.apply(this,arguments)})},{key:"cancel",value:function(e,r){if(!this._preReqChecks(null,"dealer")||!this._checkRouterFeature("dealer","call_canceling"))throw this._cache.opStatus.error;if(!e||!this._calls[e]){var t=new Errors.NonExistRPCReqIdError;throw this._fillOpStatusByError(t),t}if(!this._isPlainObject(r)&&void 0!==r){var n=new Errors.InvalidParamError("advancedOptions");throw this._fillOpStatusByError(n),n}var s;if(this._isPlainObject(r)&&Object.hasOwnProperty.call(r,"mode")){if(!["skip","kill","killnowait"].includes(r.mode)){var o=new Errors.InvalidParamError("mode");throw this._fillOpStatusByError(o),o}s=r.mode}return this._send([_constants.WAMP_MSG_SPEC.CANCEL,e,{mode:s}]),this._cache.opStatus=_objectSpread(_objectSpread({},_constants.SUCCESS),{},{reqId:e}),!0}},{key:"register",value:(t=_asyncToGenerator(_regeneratorRuntime().mark((function e(r,t,n){var s,o,i,a,c,u,l,_,p,h,d,f,y,b;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null===(s=this._rpcRegs[r])||void 0===s||null===(o=s.callbacks)||void 0===o||!o.length){e.next=4;break}throw i=new Errors.RPCAlreadyRegisteredError,this._fillOpStatusByError(i),i;case 4:if("function"==typeof t){e.next=8;break}throw a=new Errors.NoCallbackError,this._fillOpStatusByError(a),a;case 8:if(!n||this._isPlainObject(n)){e.next=12;break}throw c=new Errors.InvalidParamError("advancedOptions"),this._fillOpStatusByError(c),c;case 12:if(l=(u=n||{}).match,_=u.invoke,p=l&&!["prefix","wildcard"].includes(l),h=_&&!["single","roundrobin","random","first","last"].includes(_),!p&&!h){e.next=20;break}throw d=p?"match":"invoke",c=new Errors.InvalidParamError(d),this._fillOpStatusByError(c),c;case 20:if(this._preReqChecks({topic:r,patternBased:Boolean(l),allowWAMP:!1},"dealer")){e.next=22;break}throw this._cache.opStatus.error;case 22:return f=this._getReqId(),y=(0,_utils.getNewPromise)(),b=_objectSpread(_objectSpread({},l?{match:l}:{}),_?{invoke:_}:{}),t&&(y.rpc=t),this._requests[f]={topic:r,callbacks:y},this._send([_constants.WAMP_MSG_SPEC.REGISTER,f,b,r]),this._cache.opStatus=_objectSpread(_objectSpread({},_constants.SUCCESS),{},{reqId:f}),e.abrupt("return",y.promise);case 30:case"end":return e.stop()}}),e,this)}))),function(e,r,n){return t.apply(this,arguments)})},{key:"unregister",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function e(r){var t,n,s;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._preReqChecks({topic:r,patternBased:!1,allowWAMP:!1},"dealer")){e.next=2;break}throw this._cache.opStatus.error;case 2:if(this._rpcRegs[r]){e.next=6;break}throw t=new Errors.NonExistRPCUnregistrationError,this._fillOpStatusByError(t),t;case 6:return n=this._getReqId(),s=(0,_utils.getNewPromise)(),this._requests[n]={topic:r,callbacks:s},this._send([_constants.WAMP_MSG_SPEC.UNREGISTER,n,this._rpcRegs[r].id]),this._cache.opStatus=_objectSpread(_objectSpread({},_constants.SUCCESS),{},{reqId:n}),e.abrupt("return",s.promise);case 12:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})}]),e}();exports.Wampy=Wampy;var _default=Wampy;exports.default=_default;
//# sourceMappingURL=/sm/8e7bf96f094c930f1238ab25a856b3eccc3b4bf6f3154fca05c91f72fe85ddf2.map